<script>
  async function fileToCompressedBase64(file, maxSide = 1280, quality = 0.85) {
    const dataUrl = await new Promise(res => {
      const fr = new FileReader();
      fr.onload = () => res(fr.result);
      fr.readAsDataURL(file);
    });
    const img = new Image();
    img.src = dataUrl;
    await img.decode();

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    let { width, height } = img;

    const scale = Math.min(1, maxSide / Math.max(width, height));
    width = Math.round(width * scale);
    height = Math.round(height * scale);
    canvas.width = width;
    canvas.height = height;
    ctx.drawImage(img, 0, 0, width, height);

    // Xuất JPEG đã nén
    const out = canvas.toDataURL('image/jpeg', quality);
    return out.split(',')[1]; // base64 không kèm prefix
  }

  async function generateImage() {
    const fileInput = document.getElementById("imageUpload");
    if (!fileInput.files[0]) { alert("Vui lòng chọn ảnh"); return; }

    // 1) Nén ảnh trước khi gửi
    const base64Image = await fileToCompressedBase64(fileInput.files[0]);

    // 2) Gọi API backend
    const res = await fetch("/api/generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        prompt: "A beautiful portrait style",
        imageData: base64Image
      })
    });

    if (!res.ok) {
      const text = await res.text();
      alert("Lỗi API: " + text);
      return;
    }

    // 3) Hiển thị ảnh kết quả
    const data = await res.json();
    const candidate = data?.candidates?.[0];
    const base64Data = candidate?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
    if (base64Data) {
      document.getElementById("result").innerHTML =
        `<img src="data:image/png;base64,${base64Data}" class="max-w-md rounded"/>`;
    } else {
      alert("Không tạo được ảnh!");
    }
  }
</script>
